Разпределени софтуерни архитектури
Simple chat client-server with file transfer

Цел на проекта
Целта на проекта е осъществяване на прост клиент-сървър чат, който да може да поддържа множество потребители едновременно, които да обменят съобщения и файлове. Клиентът и сървърът трябва да са реализирани като независими приложения и да си комуникират чрез сокети, когато се налага да обменят някаква информация. Командите, които даден клиент трябва да може да изпълнява са:
-	user <username> - регистрация на потребителско име
-	send_to <username> <message> - изпращане на съобщение до даден потребител
-	send_all <message> - изпращане на съобщение до всички потребители
-	list – извеждане на списък с всички активни потребители
-	send_file_to <username> <file_name> <communication_pkg_size> - изпращане на файл до даден потребител
-	bye – уведомяване на сървъра, че клиентът приключва комуникацията
Сървърът трябва да може да получава и обработва правилно изпратените от потребителите заявки и да им връща подходящи отговори при успешна операция или при грешка. Някои от операциите, които се извършват, налагат да бъдат уведомявани и други потребители, освен изпращащият. Например, при изпращане на съобщение от един потребител към друг, изпращащият трябва да бъде уведомен дали съобщението е изпратено успешно, а получаващият, да бъде уведомен, че му е изпратено съобщение, за да може да го визуализира на екрана. При получаването на такива съобщения от сървъра, е необходимо получаването им да бъде асинхронно, т.е. да не се налага потребителят първо да изпрати съобщение, за да получи съобщение от друг потребител.
 
Реализация
За реализиране на проекта е използван програмният език Java 9 и вградените му класове и интерфейси за работа с нишки и уеб сокети (Thread, Socket, ServerSocket и др.)

Сървър
Приложението, представляващо сървърната част се намира в пакета bg.uni.sofia.rmi.server. Класът Server съдържа параметрите на сървъра като например порт, на който е достъпен, максимален брой потребители, хеш с активни потребители и др. Той съдържа и main функцията, която „слуша“ за пристигащи конекции от потребителите и при всяка получена заявка от клиент за свързване към сървъра пуска нова нишка от тип ServerThread, която има за цел да обслужва командите, които ще изпраща клиентът. 
В Server класа има ConcurrentHashMap, който пази информацията за всички активни потребители на сървъра в даден момент. Ключовете му са потребителски имена, а стойностите - от тип InetSocketAddress, за да може да се пази информация на какъв адрес и порт е достъпен „мини сървърът“ на даден потребител, който отговаря за асинхронното получаване на съобщения от централния сървър. Тази структура от данни е избрана за да се избегнат race conditions и други синхронизационни проблеми между различните нишки, когато се записват и четат потребители в нея. Използвани са атомарни операции като putIfAbsent(). Този хеш се обновява когато потребител се регистрира в системата или когато потребител прекрати връзката.
ServerThread класът наследява Thread и в своя run() метод отваря 2 потока за вход и изход от изпратения от класа Server сокет, чрез които може да комуникира с клиента. Там също се извършва и разпознаването на изпратените от клиента команди, след което се извикват съответните функции, които да ги обработват. Когато ServerThread трябва да върне някаква информация на потребителя, който е изпратил дадена команда, той използва потока за изход, предоставен от сокета. Когато обаче трябва да уведоми друг(и) клиент(и) за възникнало събитие (напр. за получаване на съобщение), вследствие на извикана команда от различен потребител, той осъществява връзка с „мини сървъра“ на клиента, когото трябва да извести и изпраща съобщението до него. Така получаването на съобщения може да се случва асинхронно и да не зависи от останалата комуникация на клиента със сървъра.

Клиент
Приложението, представляващо клиентската част се намира в пакета bg.uni.sofia.rmi.client. Класът Client съдържа член-данни, описващи параметрите на клиента като потребителско име (след като се е регистрирал), сокет (след като е реализирал успешно връзка със сървъра), нишка на „мини сървъра“, потоци за вход и изход към сървъра и др.
В класа ClientMain се съдържа main функцията на клиентското приложение, в която се прави връзка със сървъра, разпознават се написаните от потребителя команди и се изпращат за обработка към съответните функции, които комуникират със сървъра.
В main функцията на клиентското приложение се стартира нишка ClientMiniServerThread, която представлява сървър, „слушащ“ за заявки от централния сървър асинхронно. Информация за адреса и порта на този „мини сървър“ се изпращат към централния сървър по време на регистрацията, за да може да знае къде да достъпи даден потребител, когато се налага да го уведоми за някакво настъпило събитие.
От своя страна, ClientMiniServerThread „слуша“ за заявки от централния сървър и при получаване на такава, пуска нова нишка ReceiverThread, която да обработи заявката. Целта на това е да може клиентът да получава по няколко съобщения наведнъж от различни потребители или например да може да получава съобщения, докато тече изпращането на голям файл. Ако ClientMiniServerThread не пускаше нова нишка за всяка заявка от централния сървър, то клиентът нямаше да може да получава съобщения от никого докато получава файл, защото тези съобщения ще трябва да изчакат приключването на трансфера.

![Alt text](/scheme.png?raw=true)
